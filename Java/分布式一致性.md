https://zhuanlan.zhihu.com/p/86999794

### CAP理论

CAP理论告诉我们，一个分布式系统不可能同时满足一致性(Consistency)、可用性(Availability)和分区容错性(Partition Tolerance)这三个基本需求，最多同时满足其中两条

- 一致性

分布式系统中，一致性是指数据在多个副本中是否能保持一致的特征，如果对第一个节点的数据进行更新操作并更新成功后，却没有使得第二个节点上的数据得到更新，于是第二个节点的数据
仍然是老数据；在分布式系统中，如果能够做到针对一个数据项的更新操作成功后，所有的用户都能读取到最新的值，那么这样的系统就会被认为具有强一致性

- 可用性

可用性是指系统提供的服务必须一直处于可用的状态，对于用户的每一个操作总是能够在优先的时间内返回结果

- 分区容错性

分布式系统在遇到任何网络分区故障的时候，仍然需需要能够保证对外提供满足一致性和可用性服务，除非是整个网络都发生了故障

一个分布式系统不可能做到同时满足这三点。另一方面需要明确的是，对于一个分布式系统而言，分区容错性可以说是一个最基本的要求。因为既然是一个分布式系统，
那么分布式系统中的组件必然需要部署到不同的节点，因此必然会出现子网络。而对于分布式系统而言，网络问题又是一个必定会出现的异常情况，因此分区容错性
也就成为一个分布式系统必然需要面对和解决的问题。因此架构师往往需要把精力花在如何根据业务的特点在C和A之前寻求平衡。


### BASE理论

BASE是Basically Available(基本可用)、Soft state(软状态)和Eventually consistent(最终一致性)三个短语的简写。BASE是对CAP中一致性和可用性的权衡的结果。其核心思想是即便无法
做到强一致性，但是每个应用可以根据自身的业务员特点，采用适当的方式来使得系统达到最终一致性。

- 基本可用

分布式系统在出现不可预知故障的时候，允许损失部分可用性，但是这不是等价于系统不可用。比如一个请求需要0.5秒返回结果，但是因系统故障，最终花了2秒

- 软状态

允许系统中的数据存在中间状态，并认为该中间状态不会影响系统的整体可用性，即允许系统在不同节点的数据副本之间进行数据同步的过程中存在延时

- 最终一致性

最终一致性强调的是学习通中所有的数据副本在经过一段时间的同步后，最终能够达到一个一致的状态。因此，最终一致性的本质是需要系统保证最终数据能够达到一致，而不需要实时保证系统数据的强一致。最终一致性
是一种特殊的弱一致性，系统能够保障在没有其他新的更新操作下，最终达到一致的状态，因此所有的客户端对系统的数据访问能够获取到最新的值。同时，在没有发生故障的前提下，数据达到一致性状态的时间延时，取决于网络延时、系统负载、和数据复制方案设计等因素。


### 一致性算法

分布式学习通都可以通过复制状态机模型来实现，而复制状态机模型又需要一致性协议来保障各个节点的日志写入顺序，所以一致性算法尤为重要

#### 2PC

2PC是Two-Phase Commit的缩写，即二阶段提交，是计算机网络尤其是在数据库领域内，为了使基于分布式系统架构下的所有节点在进行事务处理过程中能够保持原子性和一致性设计的一种算法。通常，2阶段提交协议也被认为是一种一致性协议，用来
保证分布式系统数据的一致性。目前，绝大部分的关系型数据库都是采用二阶段提交协议完成分布式事务处理的，利用该协议能够方便地完成所有分布式事务参与者的协调，统一决定事务的提交或回滚，从而能够有效地保证分布式数据一致性。

##### 阶段1：提交事务请求

- 事务询问：协调者向所有的参与者发送事务内容，询问是否可以执行事务提交操作，并等待各位参与者的响应
- 执行事务：各参与者节点执行事务操作，并把Undo和Redo信息记录到事务日志中
- 各参与者反馈事务询问的响应：如果参与者成功执行了事务操作，那么就反馈协调者YES，标识事务可以执行。如果参与者没有成功执行事务，就反馈NO，表示事务不能执行

##### 阶段2：执行事务提交

- 假如参与者反馈的消息都是YES，那么就会执行事务提交
- 假如任一参与者反馈的消息是NO，或者等待超时之后，协调者尚无法接收到所有参与者的反馈相应，那么就会中断事务

##### 2PC的缺点分析

- 同步阻塞问题，执行过程中，所有的参与节点都是事务阻塞的，当参与者占有资源时，其他的第三方节点访问资源就会被阻塞
- 单点故障问题，因为协调者的重要性，一点协调者发生了故障，参与者会一直阻塞下去。尤其是阶段二，如果协调者出现了故障，所有的参与者都会处于锁定事务资源的状态，而无法继续完成事务（重新选举协调者有同样的问题）
- 数据不一致问题，在二阶段提交中，当协调者向参与者发送commit请求之后，发生了局部网络异常或者在发送commit请求过程中协调者发生了故障，这会导致只有一部分参与者接收到了commit请求。而在这部分参与者接收到commit
请求后，就会执行commit操作，但其他的参与者未收到commit请求，于是分布式系统便会出现数据不一致现象
- 二阶段无法解决的问题，协调者在发出commit消息之后宕机，而唯一接收这个消息的参与者也宕机了，你们即使协调者通过选举协议产生了新的协调者，这条事务的状态也是不确定的，没人知道事务是否已经被提交

#### 3PC

3PC是3-Phase Commit的缩写，它将原来的Commit拆分了PreCommit和Commit两个阶段

##### 阶段1：CanCommit

- 事务询问：协调者向所有的参与者发送一个包含事务内容的canCommit请求，询问是否可以执行事务执行操作，并开始等待各参与者的响应
- 各参与者向协调者反馈事务询问的响应：参与者在接收来自协调者的CanCommit请求后，正常情况下，如果其自身认为可以顺利执行事务，那么会反馈YES相应，并进入预备阶段，否则反馈NO响应

##### 阶段2：PreCommit

在这个阶段，协调者会根据参与者反馈来解决是否进行事务的提交，加入协调者从所有的参与者反馈的都是YES，就会执行预提交
- 事务预提交：参与者接收到preCommit请求后，会执行事务操作，并将Undo和Redo信息记录到事务日志中
- 各参与者向协调者反馈事务执行的相应：如果参与者成功执行了事务操作，那么久会反馈给协调者ACK，同时等待最终的指令，Commit或者Abort

如果任一参与者反馈了NO，或者等待超时之后，协调者无法接收到所有的反馈相应，就会中断事务
- 发送中断请求：协调者向所有的参与节点发送Abort请求
- 中断事务：无论是收到来着协调者的Abort请求，或者是在等待协调者请求过程中出现超时，参与者都会中断事务

##### 阶段3：DoCommit

如果第二阶段参与者都返回了ACK，那么协调者就会给所有的参与者发送DoCommit请求
- 事务提交：参与者接收到doCommit请求后，会正式执行事务提交操作，并在在完成提交后释放事务期间占用的资源
- 反馈事务提交结果：参与者在完成事务提交之后，向协调者发送ACK信息
- 完成事务：协调者接收到所有参与者反馈的ACK消息后，完成事务

如果第二阶段任一阶段参与者返回了NO或等待超时，那么就会执行中断事务
- 发送中断请求：协调者向所有的节点发送Abort请求
- 事务回滚：参与者接收到Abort请求后，利用Undo信息回滚事务，并释放资源
- 反馈事务回滚结果：参与者在完成事务回滚之后，向协调者发送ACK信息
- 中断事务：协调者接收到所有参与者的ACK消息后，中断事务

在doCommit阶段，如果参与者无法及时接收来自协调者的doCommit或者abort请求时，会在等待超时后，会继续进行事务的提交，这块应该是基于概率来的，因为大部分情况是正常情况

### 分布式一致性算法的实现

分布式一致性算法的实现思路也可以理解为对2PC和3PC的实现，即一阶段协调者发送数据给到参与者，参与者给回复给协调者，如果超过半数以上的参与者同意，则二阶段，协调者把数据提交。

详细参考[分布式一致性算法](./分布式一致性算法.md)






